---
title: "Analysis"
author: "Dhanushka"
format: html
editor: visual
---

## Importing the necessary libraries

```{r, message=FALSE, warning=FALSE}

library(pacman)
p_load(tidyverse, ggplot2, terra, x3ptools, prettydoc, sf, raster,lsa, cluster,
       dbscan)

```

## Importing all the scans

```{r, warning=FALSE, message=FALSE}


library(x3ptools)

## Get all scans in the folder
file_paths <- list.files("../gelsite-scans/17BW-4XHA", pattern = "\\.x3p$", full.names = TRUE)

## Read them into a named list
img_list <- setNames(lapply(file_paths, x3p_read), basename(file_paths))


```

## Create a new image list (copy of the original)

Some observed differences,

-   some images don't have the big bump (the cliff) on the left side on the scan.

-   Some images have the bump on the right side. (not on the left side as usual) That means, some of them are rotated.

-   And the axis system is different, That means, In the surface matrices of the scans, the rows are referred as **`Y`** axis while the columns are referred as the **`X`** axis.

```{r, warning=FALSE, message=FALSE}

## making a copy of the imported scans, so that you don't have to re-import again.
img_list_use <- img_list

```

## Print some Scans and see how they look like.

```{r, warning=FALSE, message=FALSE, eval=FALSE,include=FALSE}

## calling one scan
img_list_use$`scan-006.x3p` %>% 
  x3p_image()

## this is just to see whether there is any change. 

## some images don't have the big bump on the left side on the scan. and some images have the bump on the right side. (not on the left side as usual) 

img_list$`scan-513.x3p` %>% 
  x3p_image()


```

## Detecting the dust particles

-   Note: Each image is 2464 x 2056 and each pixel contains a value ranges from -0.2076582 to 0.3171508. **And also the distribution of these values are not even approximately normally distributed. (rows (y) = 2464** **, columns (x) = 2056)**
-   But, in some images, there are no outliers of the intensity values.

```{r, warning=FALSE, message=FALSE}

img_list_use$`scan-006.x3p` %>% 
  x3p_to_df() %>% 
  ggplot(aes(value)) + geom_histogram(col = "black", fill = "blue") +
  labs(title = "Distribution of the intensity values in each pixel (scan-006)", x = "intensity values") + theme(plot.title = element_text(hjust = 0.5, 
  size = 15, face = 2))
    
```

And we are using the `terra` package under which we will convert these .x3p images into raster objects. But, when we convert the images into raster objects, the coordinates will be a bit different. That is, raster coordinates starts with 0.5, 1.5, 2.5.... instead of 1,2,3,4... for each x and y coordinates.

But it doesn't change the locations of the dust spots if we keep on using the raster object. but if we want to find the actual coordinates of the dust spots on the real scan image, we must add 0.5 to each x and y coordinates.

Since the coordinate system has the issue of rows being considered as `"y"` and columns being considered as `"x"`, we need to take the transpose of the surface matrices before converting the image into a raster object.

```{r, message=FALSE, warning=FALSE}


## use the scan one (scan-006)

## creating a square with the relevant coordinates to highlight the dust. 
df <- cbind( id = 1, parts =1, x = c(1500, 1700, 1700, 1500, 1500),
  y = c(750, 750, 1000, 1000, 750))

crdref <- "+proj=longlat +datum=WGS84"
pts <- vect(df,type = "polygons", crs = crdref)
# plot(pts)


## loading the image as a raster data and plot it while highliting the dust particle
r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006)
lines(pts, col = "white",cex = 1, lwd =2)

```

On the above image, the shaded white dot is a dust spot which is really hard to see for some. That means, using raw raster objects, it is not possible to detect the dust spots clearly.

## Highlighting 2 dust spots identified through the real scan, raster image of the real scan and filtered scan by taking the lagged differences across the intensity values of the Scan-160

```{r, warning=FALSE, message=FALSE}

## Marking the possible dust particles  
## creating coordinates for lines and polygons for identified dust particles

df1 <- cbind(id = 1, part =1, x = c(400, 600, 600, 400, 400), y = c(1100, 1100, 1200, 1200, 1100)) 

df2 <- cbind(id = 2, part =2, x = c(620, 850, 850, 620, 620), y = c(1200, 1200, 1300, 1300, 1200)) 

crdref <- "+proj=longlat +datum=WGS84" 
pts1 <- vect(df1,type = "polygons", crs = crdref) 
pts2 <- vect(df2,type = "polygons", crs = crdref)


## use image 160 

## img_list_use$`scan-160.x3p` %>%
##  x3p_image()

## Using the raster object (no diff operated) 
r_160 <- rast(t(img_list_use$`scan-160.x3p`$surface.matrix))
plot(r_160, main = "Raw image")
lines(pts1, col = "white", lwd =1.5) 
lines(pts2, col = "yellow", lwd =1.5) 
text(x = 420, y = 1000,labels = "Dust 01", col = "white" , cex = 0.8) 
text(x = 1160, y = 1250,labels = "Dust 02", col = "yellow" , cex = 0.8) 

## much clear after applying the diff() operator
r_006_lag5 <- rast(diff(t(img_list_use$`scan-160.x3p`$surface.matrix), lag = 5))

## Using the raster object after applying the diff operator.
plot(r_006_lag5, main = "filtered image at lag 5")
lines(pts1, col = "white", lwd =1.5) 
lines(pts2, col = "yellow", lwd =1.5) 
text(x = 420, y = 1000,labels = "Dust 01", col = "white" , cex = 0.8) 
text(x = 1160, y = 1250,labels = "Dust 02", col = "yellow" , cex = 0.8) 

```

Here, in the above two images, its not clearly visible that there are 2 dust spots in the highlighted squares. But, if you look at the filtered image, it is obviously possible to identify the 2 dust spots.

#### Important:

we need to get the transpose of the surface matrix before converting it as a raster object because, the raster object treats X values as horizontal axis and Y values as Vertical axis. `If you don't do this, the raster object you create will be a rotated one compared to the original scan.`

```{r, message=FALSE, warning=FALSE}
##################################################################################

## taking the lagged differences row-wise across x coordinates.(Don't get confused, here i am going to get the lagged diffrences across columns in original surface matrix which is referred as the "X" coordinate.) 

# Example image (1st scan)
img_list_use <- img_list

img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=10))

r_006_col <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006_col)

r_006_col

## here, if you look at the dimension, from 2056 columns (x coordinates) has reduced to 2046. no change in rows (y coordinates))


##################################################################################


## Now, taking the lagged differences row-wise across y coordinates.(Don't get confused, here i am going to get the lagged diffrences across rows in original surface matrix which is referred as the "Y" coordinate.) 

# Example image (1st scan)
img_list_use <- img_list

img_list_use$`scan-006.x3p`$surface.matrix <- (diff(img_list_use$`scan-006.x3p`$surface.matrix, lag=10))

r_006_row <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006_row)

## here, if you look at the dimension, from 2464 rows (y coordinates) has reduced to 2454. no change in columns(x coordinates))

r_006_row
```

***It is clear that, taking lagged differences across columns (x- coordinates in original surface matrix) gives you promising results compared to taking the lagged differences across rows (y coordinates in original surface matrix)***

## Applying the Diff() function at lag =5, 10 and 15 to see which one is more effective.

Notice that the diff() function get the difference of the values (by default, **row-wise**, taking the transpose, can get the **column-wise** differences at a certain lag) at a given lag. But, the coordinate system the image has is y and x and since its wanted to investigate through horizontal cross sections.

**Therefore, We first need to take the transpose of the surface matrix 1st and then apply the diff () operator at a certain lag \[i.e. lagged difference\] and take the transpose again before updating the surface matrix of the image.**

Here, we may try several images to see how the images change when we take the higher lagged differences.

```{r, message=FALSE, warning=FALSE}
## restoring the images to list so that when we make changes, we don't have to re import the scans. we use this "img_list_use" from now on. 

img_list_use <- img_list

################################## scan 006 ######################################

img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=5))
 
## img_list_use$`scan-006.x3p` %>% 
##   x3p_image()

plot(rast(t(img_list_use$`scan-006.x3p`$surface.matrix)),main = "Scan 006,lag 5")

## lag 10 (reset and start)
img_list_use <- img_list

img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=10))

img_list_use$`scan-006.x3p` %>% 
  x3p_image()

plot(rast(t(img_list_use$`scan-006.x3p`$surface.matrix)),main = "Scan 006,lag 10")

## lag = 15 (reset and start)
img_list_use <- img_list

img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=15))

plot(rast(t(img_list_use$`scan-160.x3p`$surface.matrix)), main = "Scan 006,lag 15")

## img_list_use$`scan-006.x3p` %>% 
##   x3p_image()

## looks like for image 1 (scan 006) lag 5 is better than lag 10 or 15. 

################################ scan 160 ######################################

img_list_use <- img_list ## reset all the changes

img_list_use$`scan-160.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-160.x3p`$surface.matrix), lag=5))
# in lag 5, we still have striations 

## img_list_use$`scan-160.x3p` %>% 
##   x3p_image()

plot(rast(t(img_list_use$`scan-160.x3p`$surface.matrix)), main = "Scan 160,lag 5")

img_list_use <- img_list

img_list_use$`scan-160.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-160.x3p`$surface.matrix), lag=10))
# in lag 5, we still have striations 

## img_list_use$`scan-160.x3p` %>% 
##   x3p_image()

plot(rast(t(img_list_use$`scan-160.x3p`$surface.matrix)),main = "Scan 160,lag 10")


img_list_use <- img_list

img_list_use$`scan-160.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-160.x3p`$surface.matrix), lag=15))

# in lag 5, we still have striations 

## img_list_use$`scan-160.x3p` %>% 
##   x3p_image()

plot(rast(t(img_list_use$`scan-160.x3p`$surface.matrix)),main = "Scan 160,lag 5")

## again looks like 5 is better

## reset the changes made previously
img_list_use <- img_list



```

Its not clear which lag value is the optimal lag value, because, striation patterns will not appear at lag 5, but in lag 10. But, higher lagged differences captures only the larger dust spots while smaller lags captures smaller dust spots. So, for now, we may use the lag value as a parameter and later we may find the best lag value using some parameter tuning.

## Method I Propose : Obtain the lagged differences row-wise (X coordinates) at different lags and detect the outliers using the Q3 + 1.5 IQR as the threshold. (Implemented using the Scan 006)

Initially, we apply the diff operator at `lag 5` and find a threshold using the outliers. And obtain their coordinates and plot them on the image. **(Later, we will try higher lags)**

As a summary,

-   Use the Q3 + 1.5 IQR as the cut off value in detecting the positive outliers that could be dust. (higher values indicates spikes/bumps)

    -   **Important:** We can not find a universal threshold for all the images and lags combined as the images are different on their own.

-   Then by taking their cell numbers and respective coordinates, we can plot those points on top of the raster image (image that was filtered by applying diff(lag =5). And the results were pretty good. However, it captures other bumps on the images as dust, which could be a very tiny bump that is there because of the non-uniformity of the surface of the image.

**This works well. This is the effective method so far.**

```{r, warning=FALSE, message=TRUE}

## reset the images
img_list_use <- img_list

## apply the diff() at lag 5 on x coordinates (colums) and update the surface matrix of the image with it. 

img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=5))

## img_list_use$`scan-006.x3p` %>% 
##   x3p_image()

## Create a raster object of the image where the surface matrix got updated above and plot it. 
r_006_lag5 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006_lag5, main ="After applying diff operator at lag 5")


## identify the outliers among the filtered values using the diff (at lag 5)
bx_006_lag5 <- boxplot(values(r_006_lag5), plot =F)
## only considers the positives
bumps_006_lag5 <- bx_006_lag5$out[bx_006_lag5$out>0]


## identify their cell numbers and then coordinates
indexes_006_lag5 <- which(values(r_006_lag5) %in% bumps_006_lag5 )
coord_outliers_006_lag5 <- xyFromCell(r_006_lag5, indexes_006_lag5)

## side by side plot to compare
par(mfcol = c(1,2))

plot(r_006_lag5, main ="After Diff-filter")

plot(r_006_lag5, main ="After Diff-filter with identified Dust")
points(coord_outliers_006_lag5, col= "red", cex =1.1, pch =20)


```

## Some concerns and answers

Here arise a small problem. That is, after taking the lagged differences, we loose some dimension, and here its from the x coordinates (columns).

In other words, when we take the lagged differences on x direction (columns) at lag 5, we lose 5 columns (x's) from the original raster image. And also, when we convert the original surface matrix into a raster object, the coordinates of both x and y starts at 0.5, not 0. since we continue using the raster objects, that won't be a problem. The only problem is loosing dimension and hence detecting the correct coordinates of the dust spots on the original raster object.

I don't think we need to add the lost number of rows (columns) since it changes the relative standing of the dust when we plot them on the lagged raster object. But, when we plot them on the original raster object (hasn't lost any dimension) **we probably need to add 5 to only the x coordinate, not y.**

**As a summary......**

What Happens During `diff()` with a certain Lag

-   When I apply `diff()` with `lag = 5`, you're essentially **losing the first 5 columns** of data in each row. Because, with `lag = 5`, it subtracts each value from the one **5 steps ahead**. That means:

    -   The result starts from the **6th column** onward. **(because, the diff filter does, `x[i] - x[i–5]` and not the `x[i] - x[i+5]`)**

    -   The first 5 columns don’t have preceding values to compute the difference, so they’re dropped.

-   This means the resulting matrix is **shifted left** by 5 columns — so the pixel at column 1 in the filtered matrix corresponds to column 6 in the original image.

Why I Need to Adjust Coordinates

-   The coordinates from `xyFromCell()` on the filtered raster (`r_006_lag5`) are based on the **new matrix**, which is smaller in width.

-   To map those points back onto the **original raster**, you need to **add back the lost column offset (x coordinates),** which i'm doing with the `updated_coord_006_lag5` in the following code.

```{r, message=TRUE, warning=FALSE}

## reset the images
img_list_use <- img_list

## apply the diff() at lag 5 on x coordinates (colums) and update the surface matrix of the image with it. 

img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=5))

## img_list_use$`scan-006.x3p` %>% 
##   x3p_image()

## Create a raster object of the image where the surface matrix got updated above and plot it. 
r_006_lag5 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006_lag5, main ="After applying diff operator at lag 5")


## identify the outliers among the filtered values using the diff (at lag 5)
bx_006_lag5 <- boxplot(values(r_006_lag5), plot =F)
## only considers the positives
bumps_006_lag5 <- bx_006_lag5$out[bx_006_lag5$out>0]


## identify their cell numbers and then coordinates
indexes_006_lag5 <- which(values(r_006_lag5) %in% bumps_006_lag5 )
coord_outliers_006_lag5 <- xyFromCell(r_006_lag5, indexes_006_lag5)

## to plot on the original raster image we are updating the coordinates.(add 5 to x coordinate values) 
updated_coord_006_lag5 <- coord_outliers_006_lag5 %>% 
                            as.data.frame() %>% 
                            mutate(x = x + 5) %>% 
                            as.matrix()


###################### create the original raster image ###########################

## reset the images
img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

###################################################################################

## side by side plot to compare
par(mfcol = c(1,2))

plot(r_006_lag5, main ="After Diff-filter with identified Dust")
points(coord_outliers_006_lag5, col= "red", cex =1.1, pch =20)

plot(r_006, main ="Unfiltered imgage with identified Dust (with upadted points)")
points(updated_coord_006_lag5, col= "red", cex =1.1, pch =20)



```

## Try different lags (higher lags) and see if there is any improvement in detecting the possible dust particles on images.

Here, i found that when the lag size is increased, the previously detected smaller possible dust spots also disappear, remaining only the larger dust spots.

**Here, i am plotting the dust spots on the filtered raster object, not on the unfiltered original raster object. So, I'm not updating the coordinates based on the lost dimensions.**

```{r, message=FALSE,warning=FALSE, eval=FALSE, include=FALSE}

############################### apply the diff at lag 5 ###########################

## reset the images
img_list_use <- img_list

## uses the scan-006 and apply the diff() at lag 5.
img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=5))

## convert to a raster object
r_006_lag5 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## plot(r_006_lag5, main ="After filtered with diff(lag = 5)")


## identify the outliers
bx_006_lag5 <- boxplot(values(r_006_lag5), plot = F)

## only considers the positives
bumps_006_lag5 <- bx_006_lag5$out[bx_006_lag5$out>0]

## identify their cell numbers and then coordinates
indexes_006_lag5 <- which(values(r_006_lag5) %in% bumps_006_lag5 )
coord_outliers_006_lag5 <- xyFromCell(r_006_lag5, indexes_006_lag5)


plot(r_006_lag5, main = "After filtered with diff(lag = 5) with possible dust in 'Red' ")
points(coord_outliers_006_lag5, col= "red", cex =1.1, pch =20)


######################## apply the diff at lag 10 ################################


## reset the images
img_list_use <- img_list

## uses the scan-006 and apply the diff() at lag 10.
img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=10))

## convert to a raster object
r_006_lag10 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## plot(r_006_lag10, main ="After filtered with diff(lag = 10)")


## identify the outliers
bx_006_lag10 <- boxplot(values(r_006_lag10), plot = F)

## only considers the positives
bumps_006_lag10 <- bx_006_lag10$out[bx_006_lag10$out>0]

## identify their cell numbers and then coordinates
indexes_006_lag10 <- which(values(r_006_lag10) %in% bumps_006_lag10 )
coord_outliers_006_lag10 <- xyFromCell(r_006_lag10, indexes_006_lag10)

plot(r_006_lag10, main = "After filtered with diff(lag = 10) with possible dust in 'Red' ")
points(coord_outliers_006_lag10, col= "red", cex =1.1, pch =20)



######################## apply the diff at lag 15 ################################


## reset the images
img_list_use <- img_list

## uses the scan-006 and apply the diff() at lag 10.
img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=15))

## convert to a raster object
r_006_lag15 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## plot(r_006_lag15, main ="After filtered with diff(lag = 15)")


## identify the outliers
bx_006_lag15 <- boxplot(values(r_006_lag15), plot = F)

## only considers the positives
bumps_006_lag15 <- bx_006_lag15$out[bx_006_lag15$out>0]

## identify their cell numbers and then coordinates

indexes_006_lag15 <- which(values(r_006_lag15) %in% bumps_006_lag15 )
coord_outliers_006_lag15 <- xyFromCell(r_006_lag15, indexes_006_lag15)

plot(r_006_lag15, main = "After filtered with diff(lag = 15) with possible dust in 'Red' ")
points(coord_outliers_006_lag15, col= "red", cex =1.1, pch =20)


```

## Animated the identification of dust at different lags.

**Something important :** It can be clearly seen that the only the larger dust particles are detected at higher lags by this method. This is really cool.

*And also, here the updated coordinates are being plotted on the original raster object based on the lost dimensions at different lags.*

```{r, eval = F, include=FALSE, warning=F, message=FALSE}
library(animation)

col = c("red", "white","yellow","orange","black")
names(col) <- c(5,10,15,20,25)

saveGIF({
  for (i in c(5,10,15,20,25)){
    ##reset the image at every interation
    img_list_use <- img_list
    
    ## apply the diff () function (filter) at ith lag value and change the surface 
    ## matrix of the original image
    img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag=i))
    
    ## create a raster object from the filtered image
    r <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))
    
    bx <- boxplot(values(r), plot = F)
    outliers <- bx$out[bx$out>0]
    index <- which(values(r) %in% outliers)
    coord <- xyFromCell(r, index)
    updated_coord <- coord + i
    
    ##reset the image at every interation
    img_list_use <- img_list
    
    r_raw <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix)) 
    
    plot(r_raw, main = paste("filtered image at lag ",i))
    points(updated_coord, pch =20, cex =1, col = col[as.character(i)])
  }
  
}
    ,movie.name = "spike_animation.gif", interval = 2, ani.width = 600, 
    ani.height = 400
)



```

## Identifying and storing the information of the Dust spots such as, its coordinates, radius, size, label and lag

Strategy : assume that each dust spot is circular. Obtain the coordinate of the center of the dust spot as the location and the radius of the dust spot.

We will be using 5, 10, 15, 20, 25 as lags ( And we expect that the method only detects larger dust spots at higher lags.)

**Here in the following code chunk, we only use lag 15 for convenience on `scan-006` (because it only contains several dust spots compared to lower lags.**

Also, i will not be changing the resolution of raster objects as it gets more complicated. (i.e, once i change the resolution into microns, x, y coordinates will be interchaged and also can not plot it due to its high resolution using the plot function. `res(r_006) <- c(3.5277e-03, 3.5277e-03)`

```{r, message=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
## use the 1st image (scan-006) as an example

## reset the images

img_list_use <- img_list

## obtain x,y coordinates using x3p ( here pixel sizes are different compared to a raster image)
xy_coord_sys <- img_list_use$`scan-006.x3p` %>% 
  x3p_to_df() 

## convert to a raster object
r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## create a dataframe that has all the coordinates and intensity values corresponds to each x,y coordinate of the original scan-006
all_coord_val_r_006_unfiltered <- terra::as.data.frame(r_006, xy = T)

## note that, ccordinates will be different based on the resolution we use, but the values will not be different. (you may compare xy_coord_sys object with all_coord_val_r_006_unfiltered to see the differences)

## create a dataframe that has all the coordinates and intensity values corresponds to each x,y coordinate of the filtered scan-006 at lag 15
all_coord_val_r_006_lag15 <- terra::as.data.frame(r_006_lag15, xy = T)

## create a dataframe of the coordinate of the detected dust spots.(not the updated coordinates)
dust_coord_df_lag_15 <- as.data.frame(coord_outliers_006_lag15)

## combine the 2 data frames and update the above "dust_coord_df_lag_15" with its corresponding intensity values
dust_coord_val_r_006_lag15 <- dust_coord_df_lag_15 %>% 
  inner_join(all_coord_val_r_006_lag15, by = c("x","y"))

dust_coord_val_r_006_lag15 %>% 
  ggplot(aes(x = x, y= y, color = lyr.1)) + geom_point(aes(size = lyr.1))


all_coord_val_r_006_unfiltered %>% 
  ggplot(aes(x = x, y = y, color= lyr.1)) + geom_point() +
  geom_point(data = dust_coord_val_r_006_lag15, aes(x,y), color = "red")

```

## DBSCAN - Density Based Clustering to detect dust spots and their center coordinates with intensities and the sizes of the dust spots.

Apply Density based clustering algorithm on the dust spots detected in scan 006 using the proposed method. Here, no parameter tuning is done. This is just for the sake of demonstration.

### Try to figure out the optimal parameters in DBSCAN for a certain lag for the scan 006

```{r, warning=FALSE, message=FALSE, eval=FALSE, include=FALSE}
library(dbscan)
library(cluster)
## reset images

img_list_use <-  img_list

img_list_use$`scan-006.x3p`$surface.matrix <- (diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag =5))

## create a raster object from the filtered scan at ith lag
r_filtered_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## Find positive outliers (dust spots)
bx <- boxplot(values(r_filtered_006), plot = FALSE)
bumps <- bx$out[bx$out > 0]

## obtain the cell numbers
idx <- which(values(r_filtered_006) %in% bumps)
## find the corresponding coordinates. 
coords <- xyFromCell(r_filtered_006, idx)

# Define grid of eps and minPts
param_grid <- expand.grid(
  eps = seq(1, 5, by = 0.5),
  minPts = 2:6
)

# Store results
results <- param_grid %>%
  rowwise() %>%
  mutate(
    model = list(dbscan(coords, eps = eps, minPts = minPts)),
    n_clusters = max(model$cluster),
    n_noise = sum(model$cluster == 0),
    silhouette = if (n_clusters > 1) {
      mean(silhouette(model$cluster, dist(coords))[, 3])
    } else {
      NA_real_
    }
  ) %>%
  ungroup()

## Filter out NA or invalid cases and pick the best (closer to 1)
best <- results %>%
  filter(!is.na(silhouette)) %>%
  arrange(desc(silhouette)) %>%
  slice(1)

best

results %>% 
  mutate(min_pts = as.factor(minPts)) %>% 
  ggplot(aes(eps, silhouette, color = min_pts)) +
  geom_line() + geom_point() +
  labs(title = "Silhouette Score for DBSCAN Parameters", x = "epsilon",
       y = "Silhouette value") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  geom_vline(xintercept = 5, linetype = "dashed", color = "black")

```

Based on this tuning, we can assume that `eps = 5` and ,`minPnt = 2` gives the best results.

**The following is just a demo to see how the DBSCAN works. Later, we will be using the correct summary measures when calculating centers and radius.**

```{r, message=FALSE, warning=FALSE}

## specify the number of lags 
lags <- c(5, 10, 15, 20, 25)

dust_df <- list()

for (i in lags) {
  ## reset the scans
  img_list_use <- img_list

  ## Apply diff filter on current lag (we apply the filter on x coordinates/ columsn of the original .x3p formatted image)
  img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag = i))
  
  ## create a raster object from the filtered scan at ith lag
  r_filtered <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

  ## Find positive outliers (dust spots)
  bx <- boxplot(values(r_filtered), plot = FALSE)
  bumps <- bx$out[bx$out > 0]
  
  ## obtain the cell numbers
  idx <- which(values(r_filtered) %in% bumps)
  ## find the corresponding coordinates. 
  coords <- xyFromCell(r_filtered, idx)
  ## update the corrdinates to align with the original raster image.
  updated_coords <- coords %>% 
                            as.data.frame() %>% 
                            mutate(x = x + i) %>% 
                            as.matrix()


  if (nrow(updated_coords) == 0) next

  ## Cluster the outliers to find distinct dust spots
  eps_val <- 5  
  minPts <- 2 
  ## apply the clustering on the coordinates of identified dust spots. (later we will also consider the corresponding intensity values as well)
  cluster <- dbscan::dbscan(coords, eps = eps_val, minPts = minPts)

  ## Create a data frame of results
  df_clustered <- as.data.frame(coords) %>%
    mutate(label = cluster$cluster) %>% 
    filter(label != 0)  ## remove noise points

  # Summarize clusters: center and radius (Here i am using the mean, but i will use the maximum later)
  cluster_summary <- df_clustered %>%
    group_by(label) %>%
    summarise(
      center_x = mean(x),
      center_y = mean(y),
      radius = max(sqrt((x - center_x)^2 + (y - center_y)^2)),  # furthest point
      .groups = "drop"
    ) %>%
    mutate(lag = i)

  dust_df[[as.character(i)]] <- cluster_summary
}




```

Un-updated coordinates are used for cluster detection calculations, while, the updated coordinates have been used for other calculations such as radius and so on.

```{r, message=FALSE, warning=FALSE}

final_df <- bind_rows(dust_df) %>%
  mutate(original_x_center = center_x + lag) %>% 
  arrange(lag, label) %>%
  mutate(dust_label = paste0("dust_", lag, "_", label))

## plot the dusts on the original raster image here 
plot(r_006)
points(final_df$original_x_center, final_df$center_y, col = "red", pch =20)
symbols(final_df$original_x_center, final_df$center_y, circles = final_df$radius, inches = FALSE, add = TRUE, fg = "blue")

```

## **Density-Based Spatial Clustering of Applications with Noise**.

Here, we will use the intensity values as well in finding the clusters. and also, when it comes to identifying the centers, we will use the corresponding coordinates of highest intensity values of a particular dust spot.

Further, i am only using 2d distances to calculate the radius values. (can use 3d distances too, but might not be able to plot them)

```{r, message=FALSE, warning=FALSE}

lags <- c(5, 10, 15, 20, 25)
dust_df <- list()

## this list is used for the analysis of noise points.
cluster_list <- list()
for (i in lags) {
  ## Reset image
  img_list_use <- img_list

  ## Apply diff filter at the current lag (column-wise of the original scan)
  img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag = i))
  
  ##create a raster object from the filtered scan. 
  r_filtered <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))
  
  ## find positive outliers (dust spots)
  bx <- boxplot(values(r_filtered), plot = FALSE)
  bumps <- bx$out[bx$out > 0]
  ## identify the cell numbers of the dust spots
  idx <- which(values(r_filtered) %in% bumps)
  
  # Skip if no outliers
  if (length(idx) == 0) next
  
  ## Coordinates and the corresponding z-values (intensity) of the filtered image
  coords_xy <- xyFromCell(r_filtered, idx)
  
  ## obtain the filtered intensity values from the the filtered raster
  z_vals <- values(r_filtered)[idx]
  
  ## Combine x, y, z to  make a dataframe
  coords_3d <- cbind(coords_xy, z = z_vals)

  ## apply DBSCAN clustering on (x, y, z) coordinates.
  ## select some abritrary values for parameters 
  eps_val <- 5  
  minPts <- 2
  cluster <- dbscan::dbscan(coords_3d, eps = eps_val, minPts = minPts)

  ## Assign labels to clusters
  df_clustered <- as.data.frame(coords_3d) %>%
    mutate(label = cluster$cluster)
    
  
  if (nrow(df_clustered) == 0) next

  cluster_summary <- df_clustered %>%
  group_by(label) %>%
  summarise(
    ## use the corresponding coordinates of the maximum z value of each dust spot as the center of a particular dust spot which is a cluster here. 
    center_x = x[which.max(z)],
    center_y = y[which.max(z)],
    center_z = max(z),
    ## use the euclidine distance to get the radius.(max distance)
    radius = max(sqrt((x - x[which.max(z)])^2 + (y - y[which.max(z)])^2)),
    .groups = "drop") %>%
    mutate(lag = i) %>% 
    filter(label != 0)

  
  ## Store result
  dust_df[[as.character(i)]] <- cluster_summary
  cluster_list[[as.character(i)]] <- df_clustered
}


```

## Combining the two data frames to get the original intensity values corresponding to each center coordinate.

```{r, message=FALSE, warning=FALSE}

## I have to update the x coordinates because i need original x ccordinates corresponding to each dust spot. 

final_df_006 <- bind_rows(dust_df) %>%
  arrange(lag, label) %>%
  mutate(dust_label = paste0("dust_", lag, "_", label)) %>% 
  mutate(original_center_x = center_x + lag)


## Also, I have add the real (true) intensities to the data frame final_df_006 as well. following shows the steps. 

## reset the images

img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## create a dataframe that has all the coordinates and intensity values corresponds to each x,y coordinate of the original scan-006
all_coord_val_r_006_unfiltered <- terra::as.data.frame(r_006, xy = T)


final_df_006_updated <- final_df_006 %>%
  left_join(all_coord_val_r_006_unfiltered, 
            by = c("center_x" = "x", "center_y" = "y"))

##################### plotting the dust and radiuses ##############################

## reset the images

img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006, main = "Dust Spots Detected")
points(final_df_006_updated$center_x, final_df_006$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006_updated$center_x, final_df_006_updated$center_y, circles = final_df_006_updated$radius, inches = FALSE, add = TRUE, fg = "red")


############################### plot for lag 5 ####################################

## Plot image with centers and dust spots at lag 5 
final_df_006_updated_lag5 <- final_df_006_updated %>% 
  filter(lag == 5 ) 

plot(r_006, main = "Dust Spots Detected, lag 5")
points(final_df_006_updated_lag5$center_x, final_df_006_updated_lag5$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006_updated_lag5$center_x, final_df_006_updated_lag5$center_y, circles = final_df_006_updated_lag5$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 10 ####################################

## Plot image with centers and dust spots at lag 10 
final_df_006_updated_lag10 <- final_df_006_updated %>% 
  filter(lag == 10 ) 

plot(r_006, main = "Dust Spots Detected, lag 10")
points(final_df_006_updated_lag10$center_x, final_df_006_updated_lag10$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006_updated_lag10$center_x, final_df_006_updated_lag10$center_y, circles = final_df_006_updated_lag10$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 15 ####################################

## Plot image with centers and dust spots at lag 15 
final_df_006_updated_lag15 <- final_df_006_updated %>% 
  filter(lag == 15 ) 

plot(r_006, main = "Dust Spots Detected, lag 15")
points(final_df_006_updated_lag15$center_x, final_df_006_updated_lag15$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006_updated_lag15$center_x, final_df_006_updated_lag15$center_y, circles = final_df_006_updated_lag15$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 20 ####################################

## Plot image with centers and dust spots at lag 20 
final_df_006_updated_lag20 <- final_df_006_updated %>% 
  filter(lag == 20 ) 

plot(r_006, main = "Dust Spots Detected, at lag 20")
points(final_df_006_updated_lag20$center_x, final_df_006_updated_lag20$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006_updated_lag20$center_x, final_df_006_updated_lag20$center_y, circles = final_df_006_updated_lag20$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 25 ####################################

## Plot image with centers and dust spots at lag 25 
final_df_006_updated_lag25 <- final_df_006_updated %>% 
  filter(lag == 25 ) 

plot(r_006, main = "Dust Spots Detected, lag 25")
points(final_df_006_updated_lag25$center_x, final_df_006_updated_lag25$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006_updated_lag25$center_x, final_df_006_updated_lag25$center_y, circles = final_df_006_updated_lag25$radius, inches = FALSE, add = TRUE, fg = "red")
```

Analysis of noise-points detected by DBSCAN algorithm

```{r, warning=FALSE, message=FALSE}


############################ analysis of noise points ############################
## Lag 5

label_0_lg5_006 <- cluster_list[1] %>% 
  as.data.frame() %>% 
  filter(X5.label == 0) %>% 
  mutate(X5.x = X5.x + 5) %>% 
  rename("x" = X5.x, "y" = X5.y, "label_lag5" = X5.label) %>% 
  inner_join(all_coord_val_r_006_unfiltered, by = c("x", "y") )
  

plot(r_006)
points(label_0_lg5_006$x, label_0_lg5_006$y, col = "red")

## lag 10

label_0_lg10_006 <- cluster_list[2] %>% 
  as.data.frame() %>% 
  filter(X10.label == 0) %>% 
  mutate(X10.x = X10.x + 10) %>% 
  rename("x" = X10.x, "y" = X10.y, "label_lag5" = X10.label) %>% 
  inner_join(all_coord_val_r_006_unfiltered, by = c("x", "y") )
  

plot(r_006)
points(label_0_lg10_006$x, label_0_lg10_006$y, col = "red")


## lag 15

label_0_lg15_006 <- cluster_list[3] %>% 
  as.data.frame() %>% 
  filter(X15.label == 0) %>% 
  mutate(X15.x = X15.x + 10) %>% 
  rename("x" = X15.x, "y" = X15.y, "label_lag5" = X15.label) %>% 
  inner_join(all_coord_val_r_006_unfiltered, by = c("x", "y") )
  

plot(r_006)
points(label_0_lg15_006$x, label_0_lg15_006$y, col = "red")

## lag 20

label_0_lg20_006 <- cluster_list[4] %>% 
  as.data.frame() %>% 
  filter(X20.label == 0) %>% 
  mutate(X20.x = X20.x + 10) %>% 
  rename("x" = X20.x, "y" = X20.y, "label_lag5" = X20.label) %>% 
  inner_join(all_coord_val_r_006_unfiltered, by = c("x", "y") )
  

plot(r_006)
points(label_0_lg20_006$x, label_0_lg20_006$y, col = "red")

## lag 25 (no noise points detected)

label_0_lg25_006 <- cluster_list[5] %>% 
  as.data.frame() %>% 
  filter(X25.label == 0) %>% 
  mutate(X25.x = X25.x + 10) %>% 
  rename("x" = X25.x, "y" = X25.y, "label_lag5" = X25.label) %>% 
  inner_join(all_coord_val_r_006_unfiltered, by = c("x", "y") )
  

plot(r_006)
points(label_0_lg25_006$x, label_0_lg25_006$y, col = "red")
```

You can see that, for higher lags, number of noise points detected by the DBSCAN method is dcreasing. And almost all of these noise points are around the cliff area in the scan..

## Continue the methods, the direction of rows (y)

```{r, message=FALSE, warning=FALSE}
lags <- c(5, 10, 15, 20, 25)
dust_df_rows <- list()

for (i in lags) {
  ## Reset image
  img_list_use <- img_list
  
  ## apply the filter on row-wise again. 
  img_list_use$`scan-006.x3p`$surface.matrix <- diff(img_list_use$`scan-006.x3p`$surface.matrix, lag=i)
  
  ##create a raster object from the filtered scan. 
  r_filtered <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))
  
  ## find positive outliers (dust spots)
  bx <- boxplot(values(r_filtered), plot = FALSE)
  bumps <- bx$out[bx$out > 0]
  ## identify the cell numbers of the dust spots
  idx <- which(values(r_filtered) %in% bumps)
  
  # Skip if no outliers
  if (length(idx) == 0) next
  
  ## Coordinates and the corresponding z-values (intensity) of the filtered image
  coords_xy <- xyFromCell(r_filtered, idx)
  
  ## obtain the filtered intensity values from the the filtered raster
  z_vals <- values(r_filtered)[idx]
  
  ## Combine x, y, z to  make a dataframe
  coords_3d <- cbind(coords_xy, z = z_vals)

  ## apply DBSCAN clustering on (x, y, z) coordinates.
  ## select some abritrary values for parameters 
  eps_val <- 5  
  minPts <- 2
  cluster <- dbscan::dbscan(coords_3d, eps = eps_val, minPts = minPts)

  ## Assign labels to clusters
  df_clustered <- as.data.frame(coords_3d) %>%
    #mutate(original_x = x + i) %>% 
    mutate(label = cluster$cluster) %>% 
    filter(label != 0)  ## remove noise
  
  if (nrow(df_clustered) == 0) next

  cluster_summary <- df_clustered %>%
  group_by(label) %>%
  summarise(
    ## use the corresponding coordinates of the maximum z value of each dust spot as the center of a particular dust spot which is a cluster here. 
    center_x = x[which.max(z)],
    center_y = y[which.max(z)],
    center_z = max(z),
    ## use the euclidine distance to get the radius.(max distance)
    radius = max(sqrt((x - x[which.max(z)])^2 + (y - y[which.max(z)])^2)),
    .groups = "drop") %>%
    mutate(lag = i)

  
  ## Store result
  dust_df_rows[[as.character(i)]] <- cluster_summary
}


```

## Combining the two data frames to get the original intensity values corresponding to each center coordinate.

```{r, message=FALSE, warning=FALSE}
## I have to update the x coordinates because i need original x ccordinates corresponding to each dust spot. 

final_df_006_rows <- bind_rows(dust_df_rows) %>%
  arrange(lag, label) %>%
  mutate(dust_label = paste0("dust_", lag, "_", label)) %>% 
  mutate(original_center_y = center_y + lag)


## Also, I have add the real (true) intensities to the data frame final_df_006 as well. following shows the steps. 

## reset the images

img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## create a dataframe that has all the coordinates and intensity values corresponds to each x,y coordinate of the original scan-006
all_coord_val_r_006_unfiltered <- terra::as.data.frame(r_006, xy = T)


final_df_006__rows_updated <- final_df_006_rows %>%
  left_join(all_coord_val_r_006_unfiltered, 
            by = c("center_x" = "x", "center_y" = "y"))

##################### plotting the dust and radiuses ##############################

## reset the images

img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006, main = "Dust Spots Detected")
points(final_df_006__rows_updated$center_x, final_df_006__rows_updated$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006__rows_updated$center_x, final_df_006__rows_updated$center_y, circles = final_df_006__rows_updated$radius, inches = FALSE, add = TRUE, fg = "red")


############################### plot for lag 5 ####################################

## Plot image with centers and dust spots at lag 5 
final_df_006_updated_lag5_rows <- final_df_006__rows_updated %>% 
  filter(lag == 5 ) 

plot(r_006, main = "Dust Spots Detected, lag 5")

points(final_df_006_updated_lag5_rows$center_x, final_df_006_updated_lag5_rows$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006_updated_lag5_rows$center_x, final_df_006_updated_lag5_rows$center_y, circles = final_df_006_updated_lag5_rows$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 10 ####################################

## Plot image with centers and dust spots at lag 10 
final_df_006_updated_lag10_rows <- final_df_006__rows_updated %>% 
  filter(lag == 10 ) 

plot(r_006, main = "Dust Spots Detected, lag 10")
points(final_df_006_updated_lag10_rows$center_x, final_df_006_updated_lag10_rows$center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006_updated_lag10_rows$center_x, final_df_006_updated_lag10_rows$center_y, circles = final_df_006_updated_lag10_rows$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 15 ####################################

## Plot image with centers and dust spots at lag 15 
final_df_006_updated_lag15_rows <- final_df_006__rows_updated %>% 
  filter(lag == 15 ) 

plot(r_006, main = "Dust Spots Detected, lag 15")

points(final_df_006_updated_lag15_rows$center_x, final_df_006_updated_lag15_rows$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006_updated_lag15_rows$center_x, final_df_006_updated_lag15_rows$center_y, circles = final_df_006_updated_lag15_rows$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 20 ####################################

## Plot image with centers and dust spots at lag 20 
final_df_006_updated_lag20_row <- final_df_006__rows_updated%>% 
  filter(lag == 20 ) 

plot(r_006, main = "Dust Spots Detected, at lag 20")

points(final_df_006_updated_lag20_row$center_x, final_df_006_updated_lag20_row$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006_updated_lag20_row$center_x, final_df_006_updated_lag20_row$center_y, circles = final_df_006_updated_lag20_row$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 25 ####################################

## Plot image with centers and dust spots at lag 25 
final_df_006_updated_lag25_rows <- final_df_006__rows_updated %>% 
  filter(lag == 25 ) 

plot(r_006, main = "Dust Spots Detected, lag 25")

points(final_df_006_updated_lag25_rows$center_x, final_df_006_updated_lag25_rows$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006_updated_lag25_rows$center_x, final_df_006_updated_lag25_rows$center_y, circles = final_df_006_updated_lag25_rows$radius, inches = FALSE, add = TRUE, fg = "red")
```

As you can observe, this is really messy.

## Apply the method after filtering both row-wise and column-wise

Note that, filtering on rows 1st and columns 2nd is as same filtering of columns 1st and rows second. And in this methods, the algorithm detected lots of points as dust spots, **not good**.

```{r, message=FALSE, warning=FALSE}
lags <- c(5, 10, 15, 20, 25)
dust_df_rows_col <- list()

for (i in lags) {
  ## Reset image
  img_list_use <- img_list

  ## apply the filter on row-wise again. 
  img_list_use$`scan-006.x3p`$surface.matrix <- diff(img_list_use$`scan-006.x3p`$surface.matrix, lag=i)
  
    ## Apply diff filter at the current lag (column-wise of the original scan)
 img_list_use$`scan-006.x3p`$surface.matrix <- t(diff(t(img_list_use$`scan-006.x3p`$surface.matrix), lag = i))
 
  ##create a raster object from the filtered scan. 
  r_filtered <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))
  
  ## find positive outliers (dust spots)
  bx <- boxplot(values(r_filtered), plot = FALSE)
  bumps <- bx$out[bx$out > 0]
  ## identify the cell numbers of the dust spots
  idx <- which(values(r_filtered) %in% bumps)
  
  # Skip if no outliers
  if (length(idx) == 0) next
  
  ## Coordinates and the corresponding z-values (intensity) of the filtered image
  coords_xy <- xyFromCell(r_filtered, idx)
  
  ## obtain the filtered intensity values from the the filtered raster
  z_vals <- values(r_filtered)[idx]
  
  ## Combine x, y, z to  make a dataframe
  coords_3d <- cbind(coords_xy, z = z_vals)

  ## apply DBSCAN clustering on (x, y, z) coordinates.
  ## select some abritrary values for parameters 
  eps_val <- 5  
  minPts <- 2
  cluster <- dbscan::dbscan(coords_3d, eps = eps_val, minPts = minPts)

  ## Assign labels to clusters
  df_clustered <- as.data.frame(coords_3d) %>%
    #mutate(original_x = x + i) %>% 
    mutate(label = cluster$cluster) %>% 
    filter(label != 0)  ## remove noise
  
  if (nrow(df_clustered) == 0) next

  cluster_summary <- df_clustered %>%
  group_by(label) %>%
  summarise(
    ## use the corresponding coordinates of the maximum z value of each dust spot as the center of a particular dust spot which is a cluster here. 
    center_x = x[which.max(z)],
    center_y = y[which.max(z)],
    center_z = max(z),
    ## use the euclidine distance to get the radius.(max distance)
    radius = max(sqrt((x - x[which.max(z)])^2 + (y - y[which.max(z)])^2)),
    .groups = "drop") %>%
    mutate(lag = i)

  
  ## Store result
  dust_df_rows_col[[as.character(i)]] <- cluster_summary
}


```

### Updating the x and y coordinates and combining the corresponding original intensity values

```{r, warning=FALSE, message=FALSE}

## I have to update the x coordinates because i need original x ccordinates corresponding to each dust spot. 

final_df_006_rows_col <- bind_rows(dust_df_rows_col) %>%
  arrange(lag, label) %>%
  mutate(dust_label = paste0("dust_", lag, "_", label)) %>% 
  mutate(original_center_y = center_y + lag) %>% 
  mutate(original_center_x = center_x + lag)


## Also, I have add the real (true) intensities to the data frame final_df_006 as well. following shows the steps. 

## reset the images

img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

## create a dataframe that has all the coordinates and intensity values corresponds to each x,y coordinate of the original scan-006
all_coord_val_r_006_unfiltered <- terra::as.data.frame(r_006, xy = T)


final_df_006__rows_col_updated <- final_df_006_rows_col %>%
  left_join(all_coord_val_r_006_unfiltered, 
            by = c("original_center_x" = "x", "original_center_y" = "y"))

##################### plotting the dust and radiuses ##############################

## reset the images

img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

plot(r_006, main = "Dust Spots Detected")
points(final_df_006__rows_col_updated$original_center_x, final_df_006__rows_col_updated$original_center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006__rows_col_updated$original_center_x, final_df_006__rows_col_updated$original_center_y, circles = final_df_006__rows_col_updated$radius, inches = FALSE, add = TRUE, fg = "red")


############################### plot for lag 5 ####################################

## Plot image with centers and dust spots at lag 5 
final_df_006__rows_col_updated_lag5 <- final_df_006__rows_col_updated %>% 
  filter(lag == 5 ) 

plot(r_006, main = "Dust Spots Detected, lag 5")

points(final_df_006__rows_col_updated_lag5$original_center_x, final_df_006__rows_col_updated_lag5$original_center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006__rows_col_updated_lag5$original_center_x, final_df_006__rows_col_updated_lag5$original_center_y, circles = final_df_006__rows_col_updated_lag5$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 10 ####################################

## Plot image with centers and dust spots at lag 10 
final_df_006__rows_col_updated_lag10 <- final_df_006__rows_col_updated %>% 
  filter(lag == 10 ) 

plot(r_006, main = "Dust Spots Detected, lag 10")
points(final_df_006__rows_col_updated_lag10$original_center_x, final_df_006__rows_col_updated_lag10$original_center_y, col = "blue", pch = 20, cex = 1.2)
symbols(final_df_006__rows_col_updated_lag10$original_center_x, final_df_006__rows_col_updated_lag10$original_center_y, circles = final_df_006__rows_col_updated_lag10$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 15 ####################################

## Plot image with centers and dust spots at lag 15 
final_df_006__rows_col_updated_lag15 <- final_df_006__rows_col_updated %>% 
  filter(lag == 15 ) 

plot(r_006, main = "Dust Spots Detected, lag 15")

points(final_df_006__rows_col_updated_lag15$original_center_x, final_df_006__rows_col_updated_lag15$original_center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006__rows_col_updated_lag15$original_center_x, final_df_006__rows_col_updated_lag15$original_center_y, circles = final_df_006__rows_col_updated_lag15$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 20 ####################################

## Plot image with centers and dust spots at lag 20 
final_df_006__rows_col_updated_lag20 <- final_df_006__rows_col_updated%>% 
  filter(lag == 20 ) 

plot(r_006, main = "Dust Spots Detected, at lag 20")

points(final_df_006__rows_col_updated_lag20$original_center_x, final_df_006__rows_col_updated_lag20$original_center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006__rows_col_updated_lag20$original_center_x, final_df_006__rows_col_updated_lag20$original_center_y, circles = final_df_006__rows_col_updated_lag20$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 25 ####################################

## Plot image with centers and dust spots at lag 25 
final_df_006__rows_col_updated_lag25 <- final_df_006__rows_col_updated %>% 
  filter(lag == 25 ) 

plot(r_006, main = "Dust Spots Detected, lag 25")

points(final_df_006__rows_col_updated_lag25$original_center_x, final_df_006__rows_col_updated_lag25$original_center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_006__rows_col_updated_lag25$original_center_x, final_df_006__rows_col_updated_lag25$original_center_y, circles = final_df_006__rows_col_updated_lag25$radius, inches = FALSE, add = TRUE, fg = "red")

```

This is also not good. i need to filter out based on a good threshold on radius to obtain the possible dust spots.

## Generalizing the idea (using column-wise filtering)to all the images - only using first 5 images

```{r, warning=FALSE, message=FALSE}


## Vector of lag values
lags <- c(5, 10, 15, 20, 25)

## Initialize list to store results
dust_df_all <- list()
dust_cluster_list <- list()

# Loop through each image (only uses 5 here) in img_list_use
for (img_name in names(img_list_use)[1:5]) {
  
  # Loop through each lag value
  for (i in lags) {
    
    ## Copy the image to avoid modifying the original
    img_use <- img_list_use[[img_name]]
    
    ## Apply diff filter (column-wise, that is on x direction)
    img_use$surface.matrix <- t(diff(t(img_use$surface.matrix), lag = i))
    
    ## Create raster object from filtered matrix
    r_filtered <- rast(t(img_use$surface.matrix))
    
    ## Find positive outliers and cell indexes
    bx <- boxplot(values(r_filtered), plot = FALSE)
    bumps <- bx$out[bx$out > 0]
    idx <- which(values(r_filtered) %in% bumps)
    
    ## Skip if there are no outliers
    if (length(idx) == 0) next
    
    ## obtain the coordinates of the outliers and their filtered intensities
    coords_xy <- xyFromCell(r_filtered, idx)
    z_vals <- values(r_filtered)[idx]
    ## create a matrix array with all x, y and filtered intensities (z)
    coords_3d <- cbind(coords_xy, z_filtered = z_vals)
    
    ## Apply DBSCAN clustering using the optimal parameters
    eps_val <- 5  
    minPts <- 2
    cluster <- dbscan::dbscan(coords_3d, eps = eps_val, minPts = minPts)
    
    df_clustered <- as.data.frame(coords_3d) %>%
      mutate(label = cluster$cluster) %>% 
      mutate(lag = i,
             image_name = img_name,
             x_original = x + i)
    
    if (nrow(df_clustered) == 0) next
    
    ## obtaining the relevant information from each image for each lag
    cluster_summary <- df_clustered %>%
      group_by(label, lag, image_name) %>%
      summarise(
        center_x = x[which.max(z_filtered)],
        center_y = y[which.max(z_filtered)],
        center_z = max(z_filtered),
        radius = max(sqrt((x - x[which.max(z_filtered)])^2 + 
                            (y - y[which.max(z_filtered)])^2)),
        .groups = "drop"
      ) %>%
      filter(label != 0)
    
    ## Store results
    dust_df_all[[paste(img_name, i, sep = "_")]] <- cluster_summary
    dust_cluster_list[[paste(img_name, i, sep = "_")]] <- df_clustered
  }
}

## Combine all results into one data frame
final_df <- bind_rows(dust_df_all)
final_dust_cluster_df <- bind_rows(dust_cluster_list)

```

## Combining the two data frames to get the original intensity values corresponding to each center coordinate for each image.

### Here, the plotting is only done for scan-006

```{r, warning=FALSE, message=FALSE}


## I have to update the x coordinates because i need original x ccordinates corresponding to each dust spot. 

final_df_updated_5_images <-  final_df %>% 
  group_by(lag, label, image_name) %>%
  mutate(dust_label = paste0(image_name, "_dust_", lag, "_", label)) %>% 
  mutate(original_center_x = center_x + lag)


## Also, I have add the real (true) intensities to the data frame final_df_006 as well. following shows the steps. 

##  Extract intensity + coordinates per image
img_list_use <- img_list
all_img_coord_val_unfiltered <- list()

for (img_name in names(img_list_use)[1:5]) {
  img <- img_list_use[[img_name]]
  r <- rast(t(img$surface.matrix))
  df <- terra::as.data.frame(r, xy = TRUE) %>%
    mutate(image = img_name)
  all_img_coord_val_unfiltered[[img_name]] <- df
}

## Combine all image pixel data into one data frame
coord_val_df <- purrr::list_rbind(all_img_coord_val_unfiltered)

## Join original x,y coords with true intensity values
final_df_5_imgages_updated <- final_df_updated_5_images %>%
  left_join(coord_val_df, 
            by = c("image_name"="image", "original_center_x" = "x", "center_y" = "y"))

## only with the relevant info
final_df_5_imgages_updated %>% 
  dplyr::select(original_center_x, center_y, lyr.1, label, radius,
         lag,image_name,dust_label) %>% 
  rename("center_z" = lyr.1, "center_x" = original_center_x )


############## plotting the dust and radiuses on scan 006 ########################

## reset the images

img_list_use <- img_list

r_006 <- rast(t(img_list_use$`scan-006.x3p`$surface.matrix))

final_df_all_img_updated_006 <- final_df_5_imgages_updated %>% 
  filter(image_name == "scan-006.x3p")

plot(r_006, main = "Dust Spots Detected")

points(final_df_all_img_updated_006$original_center_x, final_df_all_img_updated_006$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_006$original_center_x, final_df_all_img_updated_006$center_y, circles = final_df_all_img_updated_006$radius, inches = FALSE, add = TRUE, fg = "red")


############################### plot for lag 5 ####################################

## Plot image with centers and dust spots at lag 5 
final_df_all_img_updated_006_lag5 <- final_df_all_img_updated_006 %>% 
  filter(lag == 5 ) 

plot(r_006, main = "Dust Spots Detected, lag 5")

points(final_df_all_img_updated_006_lag5$original_center_x, final_df_all_img_updated_006_lag5$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_006_lag5$original_center_x, final_df_all_img_updated_006_lag5$center_y, circles = final_df_all_img_updated_006_lag5$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 10 ####################################

## Plot image with centers and dust spots at lag 10 
final_df_all_img_updated_006_lag5 <- final_df_all_img_updated_006 %>% 
  filter(lag == 10 ) 

plot(r_006, main = "Dust Spots Detected, lag 10")

points(final_df_all_img_updated_006_lag5$original_center_x, final_df_all_img_updated_006_lag5$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_006_lag5$original_center_x, final_df_all_img_updated_006_lag5$center_y, circles = final_df_all_img_updated_006_lag5$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 15 ####################################

## Plot image with centers and dust spots at lag 15 
final_df_all_img_updated_006_lag15 <- final_df_all_img_updated_006 %>% 
  filter(lag == 15 ) 

plot(r_006, main = "Dust Spots Detected, lag 15")

points(final_df_all_img_updated_006_lag15$original_center_x, final_df_all_img_updated_006_lag15$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_006_lag15$original_center_x, final_df_all_img_updated_006_lag15$center_y, circles = final_df_all_img_updated_006_lag15$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 20 ####################################

## Plot image with centers and dust spots at lag 20 
final_df_all_img_updated_006_lag20 <- final_df_all_img_updated_006 %>% 
  filter(lag == 20 ) 

plot(r_006, main = "Dust Spots Detected, at lag 20")

points(final_df_all_img_updated_006_lag20$original_center_x, final_df_all_img_updated_006_lag20$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_006_lag20$original_center_x, final_df_all_img_updated_006_lag20$center_y, circles = final_df_all_img_updated_006_lag20$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 25 ####################################

## Plot image with centers and dust spots at lag 25 
final_df_all_img_updated_006_lag25 <- final_df_all_img_updated_006 %>% 
  filter(lag == 25 ) 

plot(r_006, main = "Dust Spots Detected, lag 25")

points(final_df_all_img_updated_006_lag25$original_center_x, final_df_all_img_updated_006_lag25$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_006_lag25$original_center_x, final_df_all_img_updated_006_lag25$center_y, circles = final_df_all_img_updated_006_lag25$radius, inches = FALSE, add = TRUE, fg = "red")

```

## Scan 010

```{r, warning=FALSE, message=FALSE}
############## plotting the dust and radiuses on scan 513 ########################

## reset the images

img_list_use <- img_list

r_010 <- rast(t(img_list_use$`scan-010.x3p`$surface.matrix))

final_df_all_img_updated_010 <- final_df_5_imgages_updated %>% 
  filter(image_name == "scan-010.x3p")

plot(r_010, main = "Dust Spots Detected")

points(final_df_all_img_updated_010$original_center_x, final_df_all_img_updated_010$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_010$original_center_x, final_df_all_img_updated_010$center_y, circles = final_df_all_img_updated_010$radius, inches = FALSE, add = TRUE, fg = "red")


############################### plot for lag 5 ####################################

## Plot image with centers and dust spots at lag 5 
final_df_all_img_updated_010_lag5 <- final_df_all_img_updated_010 %>% 
  filter(lag == 5 ) 

plot(r_010, main = "Dust Spots Detected, lag 5")

points(final_df_all_img_updated_010_lag5$original_center_x, final_df_all_img_updated_010_lag5$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_010_lag5$original_center_x, final_df_all_img_updated_010_lag5$center_y, circles = final_df_all_img_updated_010_lag5$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 10 ####################################

## Plot image with centers and dust spots at lag 10 
final_df_all_img_updated_010_lag10 <- final_df_all_img_updated_010 %>% 
  filter(lag == 10 ) 

plot(r_010, main = "Dust Spots Detected, lag 10")

points(final_df_all_img_updated_010_lag10$original_center_x, final_df_all_img_updated_010_lag10$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_010_lag10$original_center_x, final_df_all_img_updated_010_lag10$center_y, circles = final_df_all_img_updated_010_lag10$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 15 ####################################

## Plot image with centers and dust spots at lag 15 
final_df_all_img_updated_010_lag15 <- final_df_all_img_updated_010 %>% 
  filter(lag == 15 ) 

plot(r_010, main = "Dust Spots Detected, lag 15")

points(final_df_all_img_updated_010_lag15$original_center_x, final_df_all_img_updated_010_lag15$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_010_lag15$original_center_x, final_df_all_img_updated_010_lag15$center_y, circles = final_df_all_img_updated_010_lag15$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 20 ####################################

## Plot image with centers and dust spots at lag 20 
final_df_all_img_updated_010_lag20 <- final_df_all_img_updated_010 %>% 
  filter(lag == 20 ) 

plot(r_010, main = "Dust Spots Detected, at lag 20")

points(final_df_all_img_updated_010_lag20$original_center_x, final_df_all_img_updated_010_lag20$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_010_lag20$original_center_x, final_df_all_img_updated_010_lag20$center_y, circles = final_df_all_img_updated_010_lag20$radius, inches = FALSE, add = TRUE, fg = "red")


############################## plot for lag 25 ####################################

## Plot image with centers and dust spots at lag 25 
final_df_all_img_updated_010_lag25 <- final_df_all_img_updated_010 %>% 
  filter(lag == 25 ) 

plot(r_010, main = "Dust Spots Detected, lag 25")

points(final_df_all_img_updated_010_lag25$original_center_x, final_df_all_img_updated_010_lag25$center_y, col = "blue", pch = 20, cex = 1.2)

symbols(final_df_all_img_updated_010_lag25$original_center_x, final_df_all_img_updated_010_lag25$center_y, circles = final_df_all_img_updated_010_lag25$radius, inches = FALSE, add = TRUE, fg = "red")


```

## Analyzing the noise points in scan-010

```{r}

final_dust_cluster_df%>% 
  filter(label==0 & lag ==5 & image_name == "scan-006.x3p")

plot(r_006)
points(final_dust_cluster_df$x_original, final_dust_cluster_df$y, 
       col ="red", pch=20, cex = 1.2)
```

## Try obtaining the whole data-frame for all the scans - computationally, very expensive

```{r, warning=FALSE, message=FALSE, eval=FALSE, include=FALSE}

## Vector of lag values
lags <- c(5, 10, 15, 20, 25)

## Initialize list to store results
dust_df_all <- list()
dust_cluster_list <- list()
size <- length(names(img_list_use))

# Loop through each image (only uses 5 here) in img_list_use
for (img_name in names(img_list_use)[1:size]) {
  
  # Loop through each lag value
  for (i in lags) {
    
    ## Copy the image to avoid modifying the original
    img_use <- img_list_use[[img_name]]
    
    ## Apply diff filter (column-wise, that is on x direction)
    img_use$surface.matrix <- t(diff(t(img_use$surface.matrix), lag = i))
    
    ## Create raster object from filtered matrix
    r_filtered <- rast(t(img_use$surface.matrix))
    
    ## Find positive outliers and cell indexes
    bx <- boxplot(values(r_filtered), plot = FALSE)
    bumps <- bx$out[bx$out > 0]
    idx <- which(values(r_filtered) %in% bumps)
    
    ## Skip if there are no outliers
    if (length(idx) == 0) next
    
    ## obtain the coordinates of the outliers and their filtered intensities
    coords_xy <- xyFromCell(r_filtered, idx)
    z_vals <- values(r_filtered)[idx]
    ## create a matrix array with all x, y and filtered intensities (z)
    coords_3d <- cbind(coords_xy, z_filtered = z_vals)
    
    ## Apply DBSCAN clustering using the optimal parameters
    eps_val <- 5  
    minPts <- 2
    cluster <- dbscan::dbscan(coords_3d, eps = eps_val, minPts = minPts)
    
    df_clustered <- as.data.frame(coords_3d) %>%
      mutate(label = cluster$cluster) %>% 
      mutate(lag = i , scan_name = img_name)
    
    if (nrow(df_clustered) == 0) next
    
    ## obtaining the relevant information from each image for each lag
    cluster_summary <- df_clustered %>%
      group_by(label, scan_name, lag) %>%
      summarise(
        center_x = x[which.max(z_filtered)],
        center_y = y[which.max(z_filtered)],
        center_z = max(z_filtered),
        radius = max(sqrt((x - x[which.max(z_filtered)])^2 + 
                            (y - y[which.max(z_filtered)])^2)),
        .groups = "drop"
      ) %>%
      mutate(original_center_x = center_x + i) %>%
      filter(label != 0)
    
    ## reset the image
    img_use <- img_list_use[[img_name]]
    r_original <- rast(t(img_use$surface.matrix))
    df <- terra::as.data.frame(r_original, xy = T) %>% 
      mutate(scan_name = img_name)
    
    cluster_summary <- cluster_summary %>% 
      inner_join(df, by = c("scan_name", "original_center_x" = "x", 
      "center_y" = "y"))
    
    ## Store results
    dust_df_all[[paste(img_name, i, sep = "_")]] <- cluster_summary
    dust_cluster_list[[paste(img_name, i, sep = "_")]] <- df_clustered
  }
}

## Combine all results into one data frame
final_df_all_img <- bind_rows(dust_df_all)
final_cluster_details <- bind_rows(dust_cluster_list)


```

## Summarizes the data-frame

```{r}
## Just want to relabel the dust spots according to the image and lag 

final_df_all_img_updated <-  final_df_all_img %>% 
  group_by(lag, label, scan_name) %>%
  mutate(dust_label = paste0(scan_name, "_dust_", lag, "_", label))


## only with the relevant info
final_df_all_img_updated_info <- final_df_all_img_updated %>% 
  dplyr::select(original_center_x, center_y, lyr.1, label, radius,
         lag,scan_name,dust_label) %>% 
  rename("center_z" = lyr.1, "center_x" = original_center_x )

```

## Creating a function

```{r}

image_data <-  function(lag, img_list_use,eps=5, min_points=2){
  
  ## loading packages
  library(terra)
  library(sp)
  library(dplyr)
  library(tidyverse)
  
  ## Vector of lag values
  lags <- c(5, 10, 15, 20, 25)
  
  ## Initialize list to store results
  dust_df_all <- list()
  dust_cluster_list <- list()
  size <- length(names(img_list_use))
  
  # Loop through each image (only uses 5 here) in img_list_use
  for (img_name in names(img_list_use)[1:size]) {
    
    # Loop through each lag value
    for (i in lags) {
      
      ## Copy the image to avoid modifying the original
      img_use <- img_list_use[[img_name]]
      
      ## Apply diff filter (column-wise, that is on x direction)
      img_use$surface.matrix <- t(diff(t(img_use$surface.matrix), lag = i))
      
      ## Create raster object from filtered matrix
      r_filtered <- rast(t(img_use$surface.matrix))
      
      ## Find positive outliers and cell indexes
      bx <- boxplot(values(r_filtered), plot = FALSE)
      bumps <- bx$out[bx$out > 0]
      idx <- which(values(r_filtered) %in% bumps)
      
      ## Skip if there are no outliers
      if (length(idx) == 0) next
      
      ## obtain the coordinates of the outliers and their filtered intensities
      coords_xy <- xyFromCell(r_filtered, idx)
      z_vals <- values(r_filtered)[idx]
      ## create a matrix array with all x, y and filtered intensities (z)
      coords_3d <- cbind(coords_xy, z_filtered = z_vals)
      
      ## Apply DBSCAN clustering using the optimal parameters
      eps_val <- eps  
      minPts <- min_points
      cluster <- dbscan::dbscan(coords_3d, eps = eps_val, minPts = minPts)
      
      df_clustered <- as.data.frame(coords_3d) %>%
        mutate(label = cluster$cluster) %>% 
        mutate(lag = i , scan_name = img_name)
      
      if (nrow(df_clustered) == 0) next
      
      ## obtaining the relevant information from each image for each lag
      cluster_summary <- df_clustered %>%
        group_by(label, scan_name, lag) %>%
        summarise(
          center_x = x[which.max(z_filtered)],
          center_y = y[which.max(z_filtered)],
          center_z = max(z_filtered),
          radius = max(sqrt((x - x[which.max(z_filtered)])^2 + 
                              (y - y[which.max(z_filtered)])^2)),
          .groups = "drop"
        ) %>%
        mutate(original_center_x = center_x + i) %>%
        filter(label != 0)
      
      ## reset the image
      img_use <- img_list_use[[img_name]]
      r_original <- rast(t(img_use$surface.matrix))
      df <- terra::as.data.frame(r_original, xy = T) %>% 
        mutate(scan_name = img_name)
      
      cluster_summary <- cluster_summary %>% 
        inner_join(df, by = c("scan_name", "original_center_x" = "x", 
        "center_y" = "y"))
      
      ## Store results
      dust_df_all[[paste(img_name, i, sep = "_")]] <- cluster_summary
      dust_cluster_list[[paste(img_name, i, sep = "_")]] <- df_clustered
    }
  }
  
  ## Combine all results into one data frame
  final_df_all_img <- bind_rows(dust_df_all)
  final_all_img_cluster_details <- bind_rows(dust_cluster_list)

  ## Just want to relabel the dust spots according to the image and lag 
  
  final_df_all_img_updated <-  final_df_all_img %>% 
    group_by(lag, label, scan_name) %>%
    mutate(dust_label = paste0(scan_name, "_dust_", lag, "_", label))
  
  
  ## only with the relevant info
  final_df_all_img_updated_infomation <- final_df_all_img_updated %>% 
    dplyr::select(original_center_x, center_y, lyr.1, label, radius,
           lag,scan_name,dust_label) %>% 
    rename("center_z" = lyr.1, "center_x" = original_center_x )
  
  return(list(final_df_all_img_updated_infomation, final_all_img_cluster_details))
}

```

## Use the function: A Demo using 1st 5 images

```{r}


df_demo <- image_data(lag = c(5,10), img_list_use = img_list_use[1:5], eps = 5, min_points = 2)


## save objects

write.csv(final_cluster_details, "All_img_dust_clusters.csv", row.names = FALSE)
```
